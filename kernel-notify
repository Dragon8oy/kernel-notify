#!/bin/bash
workDir="/usr/share/kernel-notify"
iconPath="$workDir/icon.png"
version="5.7.2"
checkver="0"
test="0"

display=$(who -s | grep -Eo ' :[0-9]+' | uniq | cut -d \  -f 2)
user=$(who -s | grep "$display" | awk '{print $1}' | head -n 1)

testMode() {
  workDir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
  echo "Running kernel-notify in $workDir/"
  test="1"
}
case "$1" in
  "-t") testMode;;
  "--test") testMode;;
esac
case "$2" in
  "-t") testMode;;
  "--test") testMode;;
esac

editConfig() {
  if [ "$2" == "" ]; then
    echo "Config:" && echo ""
    cat $workDir/config
  else
    if [ "$3" == "" ]; then
      echo "Config:" && echo ""
      cat $workDir/config | grep $2
    else
      sudo sed 's|.*'$2'.*|'$2'='\"$3\"'|' $workDir/config > /tmp/kernel-config.temp
      sudo mv /tmp/kernel-config.temp $workDir/config
      echo "Saved new config"
    fi
  fi
}

source $workDir/config
cd $workDir

if [ "$test" == "0" ] && [ ! -d /etc/xdg/autostart/ ] && [ "$warnautostart" == "1" ]; then
    echo "Autostart directory not found, program will not automatically start"
fi

checkDpkg() {
  i=0
  tput sc
  echo "Checking dpkg lock..."
  while sudo fuser /var/lib/dpkg/lock >/dev/null 2>&1 ; do
    case $(($i % 4)) in
      0 ) j="-" ;;
      1 ) j="\\" ;;
      2 ) j="|" ;;
      3 ) j="/" ;;
    esac
    tput rc
    echo -en "\r[$j] Waiting for other software managers to finish... "
    sleep 1
    ((i=i+1))
  done
  echo "Done"
}

uninstall() {
  if [ "$test" == "1" ]; then
    echo "Uninstalling not supported in test mode"
    exit
  fi
  read -r -p "Are you sure you want to uninstall kernel-notify? [y/N] " response
  if [[ "$response" =~ ^([yY][eE][sS]|[yY])+$ ]]; then
    echo "Uninstalling:"
    if dpkg -s kernel-notify | grep Status |grep -q installed; then
      checkDpkg
      cd /; sudo dpkg -r kernel-notify
      exit
    else
      if [ -f /etc/xdg/autostart/kernel-notify.desktop ]; then
        sudo rm /etc/xdg/autostart/kernel-notify.desktop
      fi
      if [ -f /usr/share/applications/kernel-notify.desktop ]; then
        sudo rm /usr/share/applications/kernel-notify.desktop
      fi
      if [ -f /usr/share/man/man1/kernel-notify.1.gz ]; then
        sudo rm /usr/share/man/man1/kernel-notify.1.gz
      fi
      if [ -f /usr/share/man/man1/kernel-notify.1 ]; then
        sudo rm /usr/share/man/man1/kernel-notify.1
      fi
      sudo rm /usr/bin/kernel-notify
      sudo rm -rf /usr/share/kernel-notify
      echo "Done"
      exit
    fi
  fi
}

listConfig() {
  if [ -f /usr/share/kernel-notify/config.old ]; then
    if ! cmp --silent /usr/share/kernel-notify/config /usr/share/kernel-notify/config.old; then
      echo "Config file has changed"
      echo "Apply any config values you wish to keep with 'kernel-notify -c CFGNAME CFGVALUE'"
      echo ""
      echo "Old values:"
      cat /usr/share/kernel-notify/config.old
      echo "" && echo ""
      echo "New values:"
      cat /usr/share/kernel-notify/config
      echo "" && echo ""
    else
      echo "No change in config found"
    fi
  else
    echo "No old config file found"
  fi
}

checkKernelCount() {
  if [ "$1" != "silent" ] && [ "$1" != "alert" ]; then
    if cat /etc/*-release |grep -q Raspbian 2>&1 ; then
      return 1
    fi
  fi
  if [ ! -d "/boot" ]; then
    return
  fi
  KERNELS=$(ls /boot/ | grep vmlinuz)
  KERNELS=${KERNELS//vmlinuz-}
  KERNELS=${KERNELS//-generic}
  KERNELS=$(echo "$KERNELS" |grep -vi "vmlinuz")
  KERNELS=${KERNELS// /\n}
  KERNELS=$(echo "$KERNELS" |grep .)
  read -ra ARR <<< $(echo $KERNELS |grep .)
  if [ "$1" != "silent" ]; then
    if [ "${#ARR[@]}" -gt "$maxkernelcount" ]; then
      sendNotification "Kernel install limit reached" "Remove extra kernels with 'kernel-notify -r'" ""
      echo "Remove kernels to avoid this message, or raise the limit in the config"
    fi
  fi
}

automaticFeatures() {
  case $1 in
    am) mute; sendNotification "Program muted" "Run 'kernel-notify -um' to unmute";;
    aa) $workDir/actions -i "$latestVersion" "" -a && checkKernelCount && sendNotification "Kernel updated" "Run 'kernel-notify -r' to remove old kernels";;
    au) $workDir/updater "$version" && sendNotification "Program updated" "Run 'kernel-notify -v' to check version";;
  esac
}

zenityNotify() {
  currVersion=$(uname -r | sed 's/-.*/ /g')
  latestProgVer=$(curl -k -s https://api.github.com/repos/dragon8oy/kernel-notify/releases/latest | grep "tag_name" | cut -d v -f 2,3 | tr -d \",)
  latestVersionFull=$latestVersion
  latestVersion=$(echo "${latestVersion//.}")
  checkKernelCount "silent"
  if [ "$KERNELS" != "" ] && [ "$latestVersion" -ne "${currVersion//.}" ] && echo "$KERNELS" |grep "$latestVersionFull" > /dev/null 2>&1; then
    echo "Latest kernel version installed, reboot to take effect"
    kernelOutdated="0"
  elif [ "$latestVersion" -ne "${currVersion//.}" ]; then
    echo "Latest kernel not installed"
    kernelOutdated="1"
  else
    echo "Latest kernel version installed"
    kernelOutdated="0"
  fi
  if [ "${latestProgVer//.}" -ne "${version//.}" ]; then
    echo "Program outdated"
    progOutdated="1"
  else
    echo "Program up-to-date"
    progOutdated="0"
  fi
  if [ "$progOutdated" == "0" ] && [ "$kernelOutdated" == "0" ]; then
    zenityWindow 'zenity --info --window-icon=/usr/share/kernel-notify/icon.png --title="Kernel Updater" --text="No updates available" --width=200 --height=50'
    exit
  fi
  if [ "$?" != "0" ]; then
    sendNotification "Zenity issue detected" "An error occured while running zenity"
  fi
  latestVersion="$latestVersionFull"
}

zenityWindow() {
  if ! which zenity > /dev/null 2>&1; then
    echo "Zenity not installed, it is required for graphical menus"
    return 1
  fi
  if [ "$display" == "" ]; then
    echo "No display available"
    return 1
  fi
  sudo -u $user DISPLAY=$display DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/$(id -u $user)/bus bash -c "$1"
  #Set a variable with zenity output if it had an input window
}

mute() {
  echo "Muting kernel-notify:"
  editConfig "-c" "muted" "1"
  echo "Done";
}

unmute() {
  echo "Unmuting kernel-notify:"
  editConfig "-c" "muted" "0"
  echo "Done";
}

sendNotification() {
  if [ "$muted" == "1" ] && [ "$4" == "mute" ]; then
    echo "$1, $2"
  else
    if [ "$3" == "kernel" ] || [ "$3" == "program" ] || [ "$4" == "critical" ]; then
      if [ "$priority" == "critical" ]; then
        critical="true"
      fi
    fi
    sudo -u $user DISPLAY=$display DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/$(id -u $user)/bus $workDir/notifications "$1" "$2" "$iconPath" "$3" "$4" "$critical" > /dev/null 2>&1 &
    echo "$1, $2"
  fi
}

for i in $@; do
  for argument in $(echo "-r --remove-kernel -a --add-kernel -t --test -aa -zw"); do
    if [ "$i" == "$argument" ]; then
      checkver="1"
    fi
  done
done

if [ "$checkver" == "1" ] || [[ "$@" == "" ]]; then
  echo -n "Checking latest version..."
  latestVersion=$(echo $(curl -k https://www.kernel.org -s) | tr -d '\n' | awk -F'<td id="latest_button">' '{print $2}' | cut -c -70 | tr -d '\n' | awk -F'/' '{print $8}' | cut -c -70 | sed 's/linux-//g' | sed 's/.t.*//g')
  if [ "$latestVersion" == "" ]; then
    sleep 0.5; echo -ne "\rChecking latest version... Error\n"; sleep 0.5
    latestVersion="x.x.x"
    sendNotification "Network error" "An error occured while checking latest version"
    if [ "$1" == "-a" ] || [ "$1" == "--add-kernel" ] || [ "$1" == "-aa" ]; then
      echo "Likely a network issue, action cancelled"
      exit
    fi
  else
    echo ""
  fi
fi

read -ra args <<< $@
if [ "$1" == "-c" ] || [ "$1" == "--config" ]; then
  editConfig "$1" "$2" "$3"
  exit
else
  while [[ "$#" -gt 0 ]]; do case $1 in
    -h|--help) echo "Kernel-notify Copyright (C) 2019 Stuart Hayhurst"; echo "This program comes with ABSOLUTELY NO WARRANTY."; echo "This is free software; see the source for copying conditions."; echo ""; echo "Usage: kernel-notify [-OPTION] [-t | --test]"; echo "Program Help:"; echo "-h  | --help       : Display this page and exit"; echo "-u  | --update     : Update the program and exit"; echo "-v  | --version    : Display program version and exit"; echo "-i  | --uninstall  : Uninstall the program"; echo "-o  | --old-config : List old and new config values"; echo "-c  | --config     : Change / read a config value and exit"; echo ""; echo "Feature Help:"; echo "-r  | --remove-kernel : Remove a kernels from a menu and exit"; echo "-l  | --list-kernels  : List installed kernels and exit"; echo "-a  | --add-kernel    : Install a new kernel and exit"; echo "-um | --unmute        : Unmute the program on login"; echo "-m  | --mute          : Mute the program on login"; echo ""; echo "GitHub Link: https://github.com/Dragon8oy/kernel-notify"; echo "Issues: https://github.com/Dragon8oy/kernel-notify/issues"; echo "Program written by: Dragon8oy (Stuart Hayhurst)"; exit;;
    -u|--update) $workDir/updater "$version"; exit;;
    -v|--version) echo "Kernel-notify version: $version"; echo ""; echo "GitHub Link: https://github.com/Dragon8oy/kernel-notify"; echo "Program written by: Dragon8oy (Stuart Hayhurst)"; exit;;
    -i|--uninstall) uninstall; exit;;
    -o|--old-config) listConfig; exit;;
    -r|--remove-kernel) ./actions -r $latestVersion $maxkernelcount "${args[@]:1}"; exit;;
    -l|--list-kernels) ./actions -l "" $maxkernelcount; checkKernelCount; exit;;
    -a|--add-kernel) ./actions -i $latestVersion $2; checkKernelCount; exit;;
    -um|--unmute) unmute; exit;;
    -m|--mute) mute; exit;;
    -t|--test) ;;
    -am) automaticFeatures "am"; exit;;
    -aa) automaticFeatures "aa"; exit;;
    -au) automaticFeatures "au"; exit;;
    -zw) zenityNotify;;
    *) echo "Unknown argument passed: $1"; $( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )/kernel-notify --help; exit 1;;
  esac; shift; done
fi

currVersion=$(uname -r | sed 's/-.*/ /g')
latestVersionFull=$latestVersion
currVersionFull=$currVersion

if [ "$latestVersion" == "x.x.x" ]; then
  exit 1
fi
latestVersion=$(echo "${latestVersion//.}")

if [ "$latestVersion" -le "99" ]; then
  latestVersion=$(echo "$latestVersion""0")
  latestVersionFull=$(echo "$latestVersionFull"".0")
fi

echo "Latest Kernel: $latestVersionFull"
echo "Current Kernel: $currVersionFull"

latestProgVer=$(curl -k -s https://api.github.com/repos/dragon8oy/kernel-notify/releases/latest | grep "tag_name" | cut -d v -f 2,3 | tr -d \",)
if [ "${latestProgVer//.}" -ne "${version//.}" ]; then
  echo "" && echo "Program outdated, v$latestProgVer is available" 
  if [ "$autoupdate" -ne "0" ]; then
    echo "Auto-update is enabled, updating kernel-notify" && echo ""
    sleep 5
    pkexec kernel-notify -au
  else
    sendNotification "Version v$latestProgVer is available" "Update with 'kernel-notify -u'" "program" "mute"
  fi
fi

checkKernelCount "silent"
if [ "$KERNELS" != "" ] && [ "$latestVersion" -ne "${currVersion//.}" ] && echo "$KERNELS" |grep "$latestVersionFull" > /dev/null 2>&1; then
  echo "Latest kernel version installed, reboot to take effect"
elif [ "$latestVersion" -ne "${currVersion//.}" ]; then
  if [ "$autoupdate" -ne "0" ]; then
    echo "" && echo "Auto-update is enabled, updating kernel"
    sleep 5
    pkexec kernel-notify -aa
  else
    sendNotification "Kernel $latestVersionFull is available" "You are currently running Kernel $currVersionFull" "kernel" "mute"
  fi
fi

checkKernelCount "alert"
